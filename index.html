<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PROD - Dashboard Produzione</title>
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Prod">
    <meta name="theme-color" content="#f8fafc">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- CRITICAL CSS inline: architettura flex-column applicata prima del primo paint.
         body=colonna 100dvh | topbar=altezza automatica | contenuto=flex:1 scroll | nav=60px.
         Nessun position:fixed per topbar/nav ‚Üí nessun reflow/rimbalzo su iOS. -->
    <style>
        @media (max-width: 768px) {
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100dvh !important;
                overflow: hidden !important;
                background: #f8fafc !important;
            }
            body { position: fixed !important; inset: 0 !important; }
            .sidebar, .mobile-header { display: none !important; height: 0 !important; overflow: hidden !important; visibility: hidden !important; }
            .main-content {
                position: fixed !important;
                inset: 0 !important;
                overflow: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                background: #f8fafc !important;
            }
            .mobile-topbar {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 104px !important;
                box-sizing: border-box !important;
                padding: 10px 12px 8px !important;
                background: #f8fafc !important;
                z-index: 20 !important;
            }
            #contenitore-dati {
                position: absolute !important;
                top: 104px !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 60px !important;
                overflow-y: auto !important;
                padding: 4px 12px 12px 12px !important;
                margin: 0 !important;
            }
            .mobile-tab-bar {
                position: absolute !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 60px !important;
                padding: 0 8px 4px !important;
                box-sizing: border-box !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-around !important;
                background: #111827 !important;
                border-top: 1px solid rgba(255,255,255,0.08) !important;
                z-index: 30 !important;
            }
            .tab-item {
                flex: 1 !important;
                height: 52px !important;
                border: 0 !important;
                background: transparent !important;
                color: #9ca3af !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 1px !important;
            }
            .page-title-desktop, #desk-main-header { display: none !important; }
            .tab-item.active { color: #ffffff !important; }
            .tab-fab {
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                border: 0 !important;
                color: white !important;
                background: linear-gradient(135deg, #2563eb, #7c3aed) !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }
    </style>
    <script>
        // Tailwind via CDN (no build step). Disable preflight to avoid breaking existing styles.
        tailwind = window.tailwind || {};
        tailwind.config = {
            corePlugins: { preflight: false }
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css?v=20260223ah">
    <script>
        // Gate visuale del login: non dipendere dal caricamento di script.js
        // - se NON c'√® sessione ‚Üí mostra overlay (classe needs-login)
        // - se c'√® sessione ‚Üí overlay resta nascosto
        (function () {
            try {
                const hasSession = !!(localStorage.getItem('sessioneUtente') || sessionStorage.getItem('sessioneUtente'));
                if (!hasSession) document.documentElement.classList.add('needs-login');
            } catch (e) {
                // se localStorage non √® accessibile, richiedi comunque login
                document.documentElement.classList.add('needs-login');
            }
        })();
    </script>
    <script>
        // Funzioni login disponibili immediatamente, indipendentemente dal caricamento di script.js
        function setLoginMode(mode) {
            const isAdmin = mode === 'admin';
            const vu = document.getElementById('login-view-utente');
            const va = document.getElementById('login-view-admin');
            const err = document.getElementById('login-error');
            if (vu) vu.style.display = isAdmin ? 'none' : '';
            if (va) va.style.display  = isAdmin ? ''     : 'none';
            if (err) err.innerText = '';
            if (isAdmin) setTimeout(() => { const c = document.getElementById('login-codice'); if(c) c.focus(); }, 80);
        }
        function togglePasswordVisibility() {
            const pwd  = document.getElementById('login-password');
            const icon = document.getElementById('eye-icon');
            if (!pwd) return;
            const isHidden = pwd.type === 'password';
            pwd.type = isHidden ? 'text' : 'password';
            if (icon) icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
        }
        function verificaAccesso() {
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) errorDiv.innerText = '';

            const adminView = document.getElementById('login-view-admin');
            const isAdmin = adminView && adminView.style.display !== 'none';

            if (isAdmin) {
                // ‚îÄ‚îÄ ADMIN PIN ‚îÄ‚îÄ completamente inline, zero dipendenze da script.js
                const codice = (document.getElementById('login-codice')?.value || '').trim();
                if (codice === '0000') {
                    try {
                        localStorage.setItem('sessioneUtente', JSON.stringify({ nome: 'MASTER', ruolo: 'MASTER', vistaSimulata: 'MASTER' }));
                    } catch(e) {}
                    try {
                        sessionStorage.setItem('sessioneUtente', JSON.stringify({ nome: 'MASTER', ruolo: 'MASTER', vistaSimulata: 'MASTER' }));
                    } catch(e) {}
                    try { document.documentElement.classList.remove('needs-login'); } catch (e) {}
                    // Ricarica sempre: window.onload legge la sessione e nasconde il login
                    window.location.reload();
                } else {
                    if (errorDiv) errorDiv.innerText = 'PIN non valido.';
                    const input = document.getElementById('login-codice');
                    if (input) { input.value = ''; input.focus(); }
                }
                return;
            }

            // ‚îÄ‚îÄ LOGIN UTENTE ‚îÄ‚îÄ delega a script.js
            if (typeof _verificaAccessoUtente === 'function') {
                _verificaAccessoUtente();
            } else if (errorDiv) {
                errorDiv.innerText = 'Caricamento in corso, riprova tra un secondo.';
            }
        }

        function creaAccount() {
            const errorDiv = document.getElementById('login-error');
            if (errorDiv) errorDiv.innerText = '';
            if (typeof _creaAccountUtente === 'function') {
                _creaAccountUtente();
            } else if (errorDiv) {
                errorDiv.innerText = 'Caricamento in corso, riprova tra un secondo.';
            }
        }

        // Fallback: se esiste gi√† una sessione salvata, non bloccare l'app dietro al login
        // anche nel caso in cui script.js sia lento o non venga caricato.
        document.addEventListener('DOMContentLoaded', function () {
            let sessione = null;
            try { sessione = localStorage.getItem('sessioneUtente') || sessionStorage.getItem('sessioneUtente'); } catch (e) {}
            if (!sessione) return;
            let utente = null;
            try { utente = JSON.parse(sessione); } catch (e) { return; }

            const overlay = document.getElementById('login-overlay');
            if (overlay) overlay.style.display = 'none';

            const nameEl = document.getElementById('user-name-display');
            const avatarEl = document.getElementById('user-avatar-icon');
            if (utente && utente.nome) {
                if (nameEl) nameEl.innerText = String(utente.nome).toUpperCase();
                if (avatarEl) avatarEl.innerText = String(utente.nome).charAt(0).toUpperCase();
            }
        });
    </script>
    <script src="script.js?v=20260223o" defer></script>
</head>

<body>

    <div id="login-overlay">
        <div class="login-card">
            <div class="login-logo-container">
                <img src="logo.png" alt="Logo Prod" class="login-logo-img">
            </div>

            <!-- Vista utente normale (default) -->
            <div id="login-view-utente">
                <p>Inserisci le tue credenziali per continuare</p>
                <div class="login-form">
                    <input type="email" id="login-email" placeholder="Email aziendale" class="input-field-modern" autocomplete="email" onkeydown="if(event.key==='Enter') verificaAccesso()">
                    <input type="text" id="login-username" placeholder="Nome utente" class="input-field-modern" autocomplete="username" onkeydown="if(event.key==='Enter') verificaAccesso()">
                    <div class="login-password-row">
                        <input type="password" id="login-password" placeholder="Password" class="input-field-modern" autocomplete="current-password" onkeydown="if(event.key==='Enter') verificaAccesso()">
                        <button type="button" class="btn-toggle-pwd" onclick="togglePasswordVisibility()">
                            <i class="fas fa-eye" id="eye-icon"></i>
                        </button>
                    </div>
                    <button id="btn-login" class="btn-login" onclick="verificaAccesso()">
                        Entra nel Sistema <i class="fas fa-arrow-right"></i>
                    </button>
                    <button type="button" id="btn-signup" class="btn-login-admin-link" onclick="creaAccount()">
                        <i class="fas fa-user-plus"></i> Nuovo utente? Crea account
                    </button>
                </div>
                <button class="btn-login-admin-link" onclick="setLoginMode('admin')">
                    <i class="fas fa-shield-alt"></i> Accesso amministratore
                </button>
            </div>

            <!-- Vista admin: solo PIN -->
            <div id="login-view-admin" style="display:none">
                <h2>Area Admin</h2>
                <p>Inserisci il PIN amministratore</p>
                <div class="login-form">
                    <input type="password" id="login-codice" placeholder="‚óè ‚óè ‚óè ‚óè" class="input-field-modern login-pin-input" maxlength="6" onkeydown="if(event.key==='Enter') verificaAccesso()" autofocus>
                    <button class="btn-login" onclick="verificaAccesso()">
                        <i class="fas fa-shield-alt"></i> Entra come Admin
                    </button>
                </div>
                <button class="btn-login-admin-link" onclick="setLoginMode('utente')">
                    <i class="fas fa-arrow-left"></i> Torna al login utente
                </button>
            </div>

            <div id="login-error" class="login-error-msg"></div>
        </div>
    </div>

    <!-- TOP BAR FLOTTANTE: brand card + search card -->
    <div class="top-float-bar" id="top-float-bar">
        <div class="top-brand-card" id="top-brand-card">
            <button class="top-hamburger-btn" id="top-hamburger-btn" onclick="toggleSidebar()" title="Espandi/Chiudi menu">
                <i class="fas fa-bars"></i>
            </button>
            <button class="top-brand-home-btn" onclick="cambiaPagina('PROGRAMMA PRODUZIONE DEL MESE', null)" title="Home">
                <div class="sidebar-brand-icon">
                    <img src="logo.png" alt="PROD Logo" class="sidebar-brand-img">
                </div>
                <div class="sidebar-brand-text">
                    <span class="sidebar-brand-name">PROD</span>
                </div>
            </button>
        </div>
        <div class="top-search-card">
            <i class="fas fa-search top-search-icon"></i>
            <input type="text" id="universal-search" class="top-search-input" placeholder="Cerca in tutte le pagine..." oninput="filtraUniversale()" onkeyup="filtraUniversale()">
        </div>
    </div>

    <div class="sidebar" id="main-sidebar">

        <button type="button" class="menu-item" title="Produzione" data-page="PROGRAMMA PRODUZIONE DEL MESE" onclick="cambiaPagina('PROGRAMMA PRODUZIONE DEL MESE', this)">
            <div class="menu-content"><span>üì¶</span><span class="menu-label"> Produzione</span></div>
        </button>

        <button type="button" class="menu-item" title="Richieste" data-page="STORICO_RICHIESTE" onclick="cambiaPagina('STORICO_RICHIESTE', this)">
            <div class="menu-content"><span>üì©</span><span class="menu-label"> Richieste</span></div>
            <span id="badge-richieste-count" class="badge-sidebar-inline">0</span>
        </button>

        <button type="button" class="menu-item" title="Acquisti" data-page="MATERIALE DA ORDINARE" onclick="cambiaPagina('MATERIALE DA ORDINARE', this)">
            <div class="menu-content"><span>üõí</span><span class="menu-label"> Acquisti</span></div>
            <span id="badge-carrello-count" class="badge-sidebar-inline">0</span>
        </button>

        <button type="button" class="menu-item" title="Impostazioni" data-page="IMPOSTAZIONI" onclick="cambiaPagina('IMPOSTAZIONI', this)">
            <div class="menu-content"><span>‚öôÔ∏è</span><span class="menu-label"> Impostazioni</span></div>
        </button>

        <!-- BOTTOM: Account section -->
        <div class="sidebar-footer">
            <div class="sidebar-user-section">
                <button id="user-avatar-btn" class="user-avatar-btn" onclick="toggleAccountMenu(event)" title="Account">
                    <span id="user-avatar-icon">-</span>
                </button>
                <div class="user-info-top" id="user-info-top">
                    <span id="user-name-display">Caricamento...</span>
                </div>

                <!-- Account dropdown (si apre verso l'alto) -->
                <div id="account-dropdown" class="account-dropdown">
                    <div class="account-dropdown-header">
                        <div class="account-ddrop-avatar" id="account-ddrop-avatar">-</div>
                        <div class="account-ddrop-info">
                            <span class="account-ddrop-name" id="account-ddrop-name">‚Äî</span>
                            <span class="account-ddrop-role" id="account-ddrop-role">Utente</span>
                        </div>
                    </div>
                    <div class="account-dropdown-divider"></div>
                    <button class="account-menu-item" onclick="cambiaPagina('IMPOSTAZIONI', null); chiudiAccountMenu()">
                        <i class="fas fa-user-cog"></i> Impostazioni account
                    </button>
                    <div class="account-dropdown-divider"></div>
                    <button class="account-menu-item account-menu-logout" id="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="mobile-topbar">
            <div class="top-bar">
                <h1 id="titolo-pagina">Dashboard Produzione</h1>
            </div>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="mobile-search" placeholder="Cerca" oninput="filtraUniversale()" onkeyup="filtraUniversale()">
            </div>
        </div>
        <div id="contenitore-dati"></div>

        <!-- Pull to refresh indicator -->
        <div id="ptr-indicator">
            <i class="fas fa-arrow-down ptr-arrow"></i>
            <span class="ptr-spinner"></span>
            <span class="ptr-label">Tira per aggiornare</span>
        </div>

        <div class="mobile-tab-bar" id="mobile-tab-bar">
            <button type="button" class="tab-item active" data-page="PROGRAMMA PRODUZIONE DEL MESE" onclick="cambiaPagina('PROGRAMMA PRODUZIONE DEL MESE', this)">
                <i class="fas fa-boxes-stacked"></i>
                <span>Produzione</span>
            </button>
            <button type="button" class="tab-item" data-page="STORICO_RICHIESTE" onclick="cambiaPagina('STORICO_RICHIESTE', this)">
                <i class="fas fa-envelope"></i>
                <span>Richieste</span>
                <span id="badge-bottom-richieste" class="badge-bottom" style="display:none">0</span>
            </button>
            <button type="button" class="tab-fab" id="btn-nuova-richiesta" onclick="apriNuovaRichiesta()" aria-label="Nuova richiesta">
                <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="tab-item" data-page="MATERIALE DA ORDINARE" onclick="cambiaPagina('MATERIALE DA ORDINARE', this)">
                <i class="fas fa-cart-shopping"></i>
                <span>Acquisti</span>
            </button>
            <button type="button" class="tab-item" data-page="IMPOSTAZIONI" onclick="cambiaPagina('IMPOSTAZIONI', this)">
                <i class="fas fa-gear"></i>
                <span>Impostazioni</span>
            </button>
        </div>
    </div>

    <div id="modalAiuto" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-titolo">Dettagli</h2>
            <!-- Campo ordine: visibile solo quando si crea una nuova richiesta dal "+" -->
            <div id="modal-ordine-row" class="modal-ordine-row" style="display:none">
                <p class="modal-label">Numero Ordine:</p>
                <div class="ordine-autocomplete-wrapper">
                    <input type="text" id="modal-ordine-input" class="input-field-modern" placeholder="Cerca ordine o cliente..." autocomplete="off">
                    <div id="ordine-autocomplete" class="ordine-autocomplete-list" style="display:none"></div>
                </div>
            </div>
            <div class="modal-action-row">
                <button type="button" id="btn-tipo-assegna" class="btn-tipo" onclick="setTipoAzione('ASSEGNAZIONE')"><i class="fas fa-user-tag"></i> Assegnazione</button>
                <button type="button" id="btn-tipo-domanda" class="btn-tipo" onclick="setTipoAzione('DOMANDA')"><i class="fas fa-question-circle"></i> Domanda</button>
            </div>
            <p class="modal-label">Seleziona Destinatari:</p>
            <div id="wrapper-operatori"></div>
            <p class="modal-label">Messaggio (opzionale):</p>
            <textarea id="messaggio-aiuto" placeholder="Inserisci qui eventuali note..."></textarea>
            <div class="modal-footer">
                <button type="button" onclick="chiudiModal()" class="btn-modal-cancel">Annulla</button>
                <button type="button" onclick="confermaInvioSupporto()" class="btn-modal-send">
                    <i class="fas fa-paper-plane"></i> Invia Messaggio
                </button>
            </div>
        </div>
    </div>

    <button id="floating-cart-btn" onclick="apriModalCarrello()" style="display:none">
            <i class="fas fa-shopping-cart"></i>
            <span>Carrello (<span id="cart-qty-val">0</span>)</span>
    </button>

  <div id="modal-carrello">
      <div class="modal-carrello-box">
          <div class="modal-header">
              <h3>üõí Carrello</h3>
              <button onclick="chiudiModalCarrello()" class="btn-close">&times;</button>
          </div>
          <div id="lista-articoli-carrello"></div>
          <div class="modal-footer">
               <button onclick="chiudiModalCarrello()" class="btn-modal-cancel">Chiudi</button>
               <button id="btn-invia-alessio" onclick="inviaOrdineAcquisti()" class="btn-modal-send">Invia ad Alessio</button>
          </div>
      </div>
  </div>

  <div id="modal-gestione-articolo" class="modal-articoli-overlay" onclick="if(event.target===this) chiudiModalArticolo()">
      <div class="modal-articoli-box">
          <h3 id="titolo-modal-articolo">Nuovo Articolo</h3>
          <input type="hidden" id="edit-id-riga">

          <div class="modal-articolo-field">
              <label for="edit-nome">NOME PRODOTTO</label>
              <input type="text" id="edit-nome">
          </div>

          <div class="modal-articolo-field">
              <label for="edit-codice">CODICE</label>
              <input type="text" id="edit-codice">
          </div>

          <div class="modal-articolo-field">
              <label for="edit-fornitore">FORNITORE</label>
              <input type="text" id="edit-fornitore">
          </div>

          <div class="modal-articolo-footer">
              <button onclick="chiudiModalArticolo()" class="btn-modal-art-cancel">Annulla</button>
              <button id="btn-salva-articolo" onclick="salvaArticolo()" class="btn-modal-art-send">Salva</button>
          </div>
      </div>
  </div>

  <!-- Modal conferma generico -->
  <div id="modal-conferma" class="modal-overlay" onclick="if(event.target===this) _chiudiConferma()">
      <div class="modal-content modal-conferma-box">
          <h3 id="modal-conferma-titolo" class="modal-conferma-titolo"></h3>
          <p id="modal-conferma-msg" class="modal-conferma-msg"></p>
          <div class="modal-footer">
              <button type="button" onclick="_chiudiConferma()" class="btn-modal-cancel">Annulla</button>
              <button type="button" id="modal-conferma-ok" class="btn-modal-send">Conferma</button>
          </div>
      </div>
  </div>

  <!-- Modal: sposta articolo in sezione -->
  <div id="modal-sposta-sezione" class="modal-overlay" onclick="if(event.target===this) chiudiModalSpostaSezione()">
      <div class="modal-content">
          <h2>Sposta in sezione</h2>
          <input type="hidden" id="sposta-id-riga">
          <p class="modal-label" style="margin-top:18px">Seleziona sezione di destinazione:</p>
          <select id="sposta-sezione-select" class="input-field-modern" style="width:100%;margin-top:8px;background:white;color:#1e293b;border:1px solid #e2e8f0;border-radius:10px;padding:11px 14px;font-size:14px;font-weight:600;cursor:pointer;"></select>
          <div class="modal-footer" style="margin-top:24px">
              <button type="button" onclick="chiudiModalSpostaSezione()" class="btn-modal-cancel">Annulla</button>
              <button type="button" onclick="confermaSpostaSezione()" class="btn-modal-send">
                  <i class="fas fa-folder-open"></i> Sposta
              </button>
          </div>
      </div>
  </div>

  <!-- Modal: crea nuova sezione -->
  <div id="modal-nuova-sezione" class="modal-overlay" onclick="if(event.target===this) chiudiModalNuovaSezione()">
      <div class="modal-content">
          <h2>Nuova sezione</h2>
          <p class="modal-label" style="margin-top:18px">Nome della sezione:</p>
          <input type="text" id="nuova-sezione-nome" class="input-field-modern" placeholder="Es. Colori, Nastri, Pulizia..." style="width:100%;margin-top:8px;box-sizing:border-box" onkeydown="if(event.key==='Enter') confermaNuovaSezione()">
          <div class="modal-footer" style="margin-top:24px">
              <button type="button" onclick="chiudiModalNuovaSezione()" class="btn-modal-cancel">Annulla</button>
              <button type="button" onclick="confermaNuovaSezione()" class="btn-modal-send">
                  <i class="fas fa-folder-plus"></i> Crea
              </button>
          </div>
      </div>
  </div>

  <div id="modal-rinomina-sezione" class="modal-overlay" onclick="if(event.target===this) chiudiModalRinominaSezione()">
      <div class="modal-content">
          <h2><i class="fas fa-pen" style="margin-right:8px;font-size:16px"></i>Rinomina sezione</h2>
          <p class="modal-label" style="margin-top:18px">Nuovo nome:</p>
          <input type="text" id="rinomina-sezione-nome" class="input-field-modern" placeholder="Es. Colori, Nastri, Pulizia..." style="width:100%;margin-top:8px;box-sizing:border-box" onkeydown="if(event.key==='Enter') confermaRinominaSezione()">
          <input type="hidden" id="rinomina-sezione-vecchio">
          <div class="modal-footer" style="margin-top:24px">
              <button type="button" onclick="chiudiModalRinominaSezione()" class="btn-modal-cancel">Annulla</button>
              <button type="button" onclick="confermaRinominaSezione()" class="btn-modal-send">
                  <i class="fas fa-check"></i> Salva
              </button>
          </div>
      </div>
  </div>

</body>
</html>
